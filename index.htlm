<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>Millionaire Power â€” v2.3 (NBâ€‘LEL Reports)</title>
<style>
:root{
  --bg:#0f1321;--panel:#161a2a;--muted:#8ea3c0;--text:#eaf0ff;
  --accent:#5f7dff;--good:#2ecc71;--bad:#ff5c5c;--gold:#ffd166;
  --chip:#1d2238;--chipOn:#2a3150
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#0f1321,#0b1120);color:var(--text);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
.wrap{max-width:1200px;margin:0 auto;padding:20px}
.top{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
h1{font-size:20px;margin:0 10px 0 0}
.btn{background:var(--chip);border:1px solid rgba(255,255,255,.08);color:var(--text);
  padding:10px 12px;border-radius:10px;cursor:pointer}
.btn:active{transform:scale(.98)}
.grid{display:grid;grid-template-columns: 1.2fr 1fr; gap:14px;margin-top:14px}
.card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;box-shadow: 0 8px 20px rgba(0,0,0,.2)}
.kpis{display:grid;grid-template-columns:repeat(8,1fr);gap:8px}
.kpis .k{background:var(--chip);padding:10px;border-radius:12px;text-align:center}
.k .v{font-weight:700;font-size:18px}
.pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.pill{background:var(--chip);border-radius:30px;padding:6px 10px;border:1px solid rgba(255,255,255,.06);display:flex;gap:6px;align-items:center}
.pill .dot{width:6px;height:6px;border-radius:50%;background:var(--muted)}
.pill.good .dot{background:var(--good)} .pill.bad .dot{background:var(--bad)}
.bottlesRow{display:flex;gap:6px;align-items:center;margin-top:8px}
.bottle{width:18px;height:44px;border-radius:4px;background:rgba(160,210,255,.15);border:2px solid rgba(160,210,255,.4); position:relative;overflow:hidden}
.bottle.fill::after{content:''; position:absolute; left:0; right:0; bottom:0; height:70%; background:rgba(120,185,255,.9)}
/* Room */
.room{position:relative; height:380px; overflow:hidden}
.stage{position:absolute; inset:14px; background:#0e1426; border:1px solid rgba(255,255,255,.07); border-radius:12px}
.floor{position:absolute; left:0; right:0; bottom:0; height:70px; background:linear-gradient(180deg,#151a2d,#0b0f1f);}
.bench{position:absolute; left:90px; bottom:80px; width:260px; height:70px; background:#1b2136; border-radius:8px}
.bar{position:absolute; left:85px; bottom:150px; width:270px; height:16px;background:#2a314d;border-radius:8px}
.whiteboard{position:absolute; left:330px; top:60px; width:230px; height:140px; background:#f4f7ff; color:#233; border-radius:10px; padding:10px; box-shadow:0 8px 16px rgba(0,0,0,.35)}
.whiteboard h4{margin:0 0 6px 0}
.bottles{position:absolute; left:310px; bottom:88px; display:flex; gap:6px}
/* Pull-up bar */
.pulbar{position:absolute; left:20px; top:20px; width:120px; height:290px; border-left:6px solid #1f2742; border-right:6px solid #1f2742; border-top:10px solid #1f2742; border-radius:8px}
/* Avatar SVG */
.avatar{position:absolute; right:40px; bottom:70px; width:180px; height:250px}
svg{width:100%;height:100%}
.armR{transform-origin: 120px 120px; transition: transform .25s ease}
.can, .cup, .phone, .smoke{opacity:0; transition:opacity .15s ease}
.glow{filter: drop-shadow(0 0 6px #ffb347)}
/* Controls */
.controls .row{display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px dashed rgba(255,255,255,.06)}
.controls .left{display:flex; align-items:center; gap:8px; font-weight:600}
.counter{display:flex; align-items:center; gap:8px}
.counter .n{width:40px; text-align:center}
.counter button{width:34px;height:34px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#1c2240;color:var(--text);cursor:pointer}
.help{color:var(--muted); font-size:12px}
.helpIcon{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;border:1px solid rgba(255,255,255,.25);font-size:12px;opacity:.8;cursor:help}
.helpIcon:hover{opacity:1}
.tags{display:flex; gap:6px; flex-wrap:wrap; margin-top:6px}
.tag{background:var(--chip); border:1px solid rgba(255,255,255,.08); padding:5px 8px; border-radius:10px}
.fin .src{display:flex; gap:8px; flex-wrap:wrap;margin-top:6px}
.fin input[type=number]{background:#192042;color:var(--text);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:8px;width:100px}
.fin select{background:#192042;color:var(--text);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:8px}
.badge{background:#1d2240;border:1px solid rgba(255,255,255,.1);padding:6px 10px;border-radius:12px;display:inline-block;margin:4px 6px 0 0}
.progress{height:10px;background:#1c2240;border:1px solid rgba(255,255,255,.08);border-radius:10px;overflow:hidden}
.progress>span{display:block;height:100%;background:linear-gradient(90deg,#5f7dff,#ffd166);width:0%}
.modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.55)}
.modal .box{background:#121833; border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:16px; width:clamp(280px, 80vw, 860px); color:#e9eeff}
.close{float:right; cursor:pointer; background:#1d2240; border:1px solid rgba(255,255,255,.1); padding:6px 10px; border-radius:8px}
.small{font-size:12px;color:var(--muted)}
.footer{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>Millionaire Power â€” v2.3</h1>
    <div id="dayBadge" class="btn">ğŸ“… Day 1</div>
    <button class="btn" id="btnFinish">ğŸ Finir la journÃ©e</button>
    <button class="btn" id="btnReport">ğŸ“„ Rapports</button>
    <button class="btn" id="btnTest">ğŸ§ª Mode Test</button>
    <button class="btn" id="btnReset">ğŸ” Reset</button>
  </div>

  <div class="card">
    <div class="kpis" id="kpis"></div>
    <div class="pills" id="pills"></div>
    <div class="bottlesRow" id="dashBottles"></div>
    <div class="small">Objectif annuel: <b>1,000,000 points</b>
      <div class="progress"><span id="progBar"></span></div>
      <div class="small" id="progTxt"></div>
    </div>
  </div>

  <div class="grid">
    <div class="card room" id="room">
      <div class="stage" aria-label="Chambre de Gabriel">
        <div class="pulbar"></div>
        <div class="bar"></div>
        <div class="bench"></div>
        <div class="whiteboard">
          <h4>QUOTE</h4>
          <div id="quoteTxt">Dream big, you can do anything.</div>
          <button class="btn" id="btnQuote" style="margin-top:6px">ğŸ”„ Nouvelle quote</button>
        </div>
        <div class="bottles" id="bottles"></div>

        <div class="avatar" id="avatar">
          <svg viewBox="0 0 180 250">
            <rect x="65" y="170" width="20" height="70" rx="10" fill="#4a66b8"/>
            <rect x="95" y="170" width="20" height="70" rx="10" fill="#4a66b8"/>
            <rect x="50" y="100" width="80" height="80" rx="16" fill="#5c7ce0"/>
            <circle cx="80" cy="140" r="12" fill="#c0545b"/>
            <circle cx="100" cy="140" r="12" fill="#c0545b"/>
            <rect x="32" y="120" width="16" height="50" rx="8" fill="#5c7ce0"/>
            <g class="armR" id="armR">
              <rect x="132" y="120" width="16" height="50" rx="8" fill="#5c7ce0"/>
            </g>
            <circle cx="90" cy="80" r="26" fill="#f0c69a"/>
            <rect x="60" y="60" width="60" height="18" rx="9" fill="#8d5e3a"/>
            <rect x="64" y="68" width="22" height="8" rx="3" fill="#0b0f1f"/>
            <rect x="94" y="68" width="22" height="8" rx="3" fill="#0b0f1f"/>
            <path d="M78,90 Q90,100 102,90" stroke="#0b0f1f" stroke-width="4" fill="none"/>
            <text x="84" y="58" text-anchor="middle" font-size="10" fill="#d7b48a">LA</text>
            <rect id="can" class="can" x="130" y="135" width="14" height="24" rx="3" fill="#9ed0ff" stroke="#c8e6ff"/>
            <rect id="cup" class="cup" x="130" y="135" width="18" height="22" rx="3" fill="#b3d7ff" stroke="#eaf3ff"/>
            <rect id="phone" class="phone" x="126" y="130" width="22" height="34" rx="4" fill="#222"/>
            <g id="smoke" class="smoke">
              <circle cx="60" cy="116" r="3" fill="#cbd2e9" opacity=".8"/>
              <circle cx="54" cy="108" r="2" fill="#cbd2e9" opacity=".6"/>
              <circle cx="50" cy="100" r="1.6" fill="#cbd2e9" opacity=".4"/>
            </g>
          </svg>
        </div>
        <div class="floor"></div>
      </div>
    </div>

    <div class="card controls">
      <div class="row"><div class="left">ğŸ’§ Eau (12Ã—250 ml) <span class="helpIcon" title="Hydratation = Ã©nergie, concentration, meilleure rÃ©cupÃ©ration. Objectif: 8â€“12 verres/jour.">?</span></div>
        <div class="counter"><button data-ctl="eau" data-d="-1">âˆ’</button><div class="n" id="n_eau">0</div><button data-ctl="eau" data-d="1">+</button></div>
      </div>
      <div class="help small">Conseil: vise 2â€“3 L/jour (8â€“12 verres), espace sur la journÃ©e.</div>

      <div class="row"><div class="left">ğŸ˜´ Sommeil (h) <span class="helpIcon" title="7â€“9 h optimisent la mÃ©moire, les hormones, la performance et lâ€™humeur.">?</span></div>
        <div class="counter"><button data-ctl="sleep" data-d="-1">âˆ’</button><div class="n" id="n_sleep">0</div><button data-ctl="sleep" data-d="1">+</button></div>
      </div>
      <div class="tags"><label class="tag"><input id="lever5" type="checkbox"> Lever 5h</label><label class="tag"><input id="coucher21" type="checkbox"> Coucher 21h</label></div>

      <div class="row"><div class="left">ğŸ“š Ã‰tude (h) <span class="helpIcon" title="Apprentissage constant = plus de valeur sur le marchÃ©. Vise 1â€“3 h/jour.">?</span></div>
        <div class="counter"><button data-ctl="study" data-d="-1">âˆ’</button><div class="n" id="n_study">0</div><button data-ctl="study" data-d="1">+</button></div>
      </div>

      <div class="row"><div class="left">ğŸš¬ Nicotine <span class="helpIcon" title="RÃ©duire la nicotine amÃ©liore la respiration, lâ€™Ã©nergie et le portefeuille.">?</span></div>
        <div class="counter"><button data-ctl="nic" data-d="-1">âˆ’</button><div class="n" id="n_nic">0</div><button data-ctl="nic" data-d="1">+</button></div>
      </div>

      <div class="row"><div class="left">ğŸŒ¿ Weed <span class="helpIcon" title="ModÃ©ration: trop peut affecter la motivation et la mÃ©moire.">?</span></div>
        <div class="counter"><button data-ctl="weed" data-d="-1">âˆ’</button><div class="n" id="n_weed">0</div><button data-ctl="weed" data-d="1">+</button></div>
      </div>

      <div class="row"><div class="left">ğŸº Alcool (verres) <span class="helpIcon" title="Moins = meilleur sommeil, meilleure rÃ©cupÃ©ration et clartÃ© mentale.">?</span></div>
        <div class="counter"><button data-ctl="alc" data-d="-1">âˆ’</button><div class="n" id="n_alc">0</div><button data-ctl="alc" data-d="1">+</button></div>
      </div>

      <div class="row"><div class="left">ğŸ“± Porn <span class="helpIcon" title="Baisse la distraction, remonte la dopamine naturelle.">?</span></div>
        <div class="counter"><button data-ctl="porn" data-d="-1">âˆ’</button><div class="n" id="n_porn">0</div><button data-ctl="porn" data-d="1">+</button></div>
      </div>

      <div class="row"><div class="left">ğŸ’ª Pull-up <span class="helpIcon" title="Tractions = force du dos/bras, posture, discipline.">?</span></div>
        <div class="counter"><button id="btnPull">+1</button></div>
      </div>

      <div class="row"><div class="left">ğŸ¤ HonnÃªtetÃ© <span class="helpIcon" title="Confiance + crÃ©dibilitÃ© = meilleures relations et business.">?</span></div>
        <div><button class="btn" id="bHon">+1 honnÃªte</button> <button class="btn" id="bFaux">+1 faux</button></div>
      </div>
      <div class="row"><div class="left">ğŸ™ PriÃ¨re <span class="helpIcon" title="Calme, gratitude, recentrage.">?</span></div><button class="btn" id="bPray">Basculer</button></div>
      <div class="row"><div class="left">ğŸ“ RÃ©flexion fin de journÃ©e <span class="helpIcon" title="Boucle dâ€™apprentissage: ce qui a bien Ã©tÃ©, Ã  amÃ©liorer, next steps.">?</span></div><button class="btn" id="bReflect">Basculer</button></div>

      <!-- Chores (toggle) -->
      <div class="row"><div class="left">ğŸª¥ Brossage dents <span class="helpIcon" title="Dents propres = santÃ© bucco-dentaire + discipline.">?</span></div><button class="btn" id="bDents">Basculer</button></div>
      <div class="row"><div class="left">ğŸ›ï¸ Nettoyer chambre <span class="helpIcon" title="Espace clean = esprit clair, productivitÃ©.">?</span></div><button class="btn" id="bChambre">Basculer</button></div>
      <div class="row"><div class="left">ğŸš— Nettoyer voiture <span class="helpIcon" title="Outil de travail propre = image pro + motivation.">?</span></div><button class="btn" id="bVoiture">Basculer</button></div>
      <div class="row"><div class="left">ğŸ› Nettoyer salle de bain <span class="helpIcon" title="HygiÃ¨ne + environnement clean = meilleur mindset.">?</span></div><button class="btn" id="bSalleBain">Basculer</button></div>

      <div class="fin">
        <h3>Finance</h3>
        <div id="finBadges" class="tags"></div>
      </div>
    </div>
  </div>

  <div class="card footer">
    <div id="saveInfo" class="small">Auto-sauvegarde locale activÃ©e.</div>
  </div>
</div>

<!-- Reports modal -->
<div class="modal" id="modal">
  <div class="box">
    <button class="close" id="closeM">Fermer</button>
    <h3>Rapports (NBâ€‘LEL)</h3>
    <div class="tags">
      <button class="btn" data-rpt="day">Rapport du jour</button>
      <button class="btn" data-rpt="week">Rapport de la semaine</button>
      <button class="btn" data-rpt="month">Rapport du mois</button>
      <button class="btn" data-rpt="year">Rapport de l'annÃ©e</button>
      <button class="btn" id="btnPDF">ğŸ“¥ TÃ©lÃ©charger PDF</button>
    </div>
    <pre id="report" style="white-space:pre-wrap"></pre>
  </div>
</div>

<!-- Test modal -->
<div class="modal" id="modalTest">
  <div class="box">
    <button class="close" id="closeT">Fermer</button>
    <h3>Mode Test</h3>
    <div class="tags">
      <label class="tag">DurÃ©e:
        <select id="testDuration">
          <option value="1">1 jour</option>
          <option value="7">1 semaine (7 j)</option>
          <option value="30">1 mois (30 j)</option>
          <option value="365">1 annÃ©e (365 j)</option>
        </select>
      </label>
      <label class="tag">DifficultÃ©:
        <select id="testDiff">
          <option value="easy">Facile</option>
          <option value="normal" selected>Normal</option>
          <option value="hard">Difficile</option>
          <option value="insane">Insane</option>
        </select>
      </label>
    </div>
    <button class="btn" id="launchTest">Lancer</button>
    <div class="small">Le test simule des journÃ©es et applique la difficultÃ© (motivation vs. pÃ©nalitÃ©s).</div>
  </div>
</div>

<script>
// ---------- State & persistence ----------
const state = JSON.parse(localStorage.getItem('mp_state_v23')||'{}');
const todayISO = new Date().toISOString().slice(0,10);
const data = Object.assign({
  eau:0, sleep:0, study:0, nic:0, weed:0, alc:0, porn:0,
  lever5:false, coucher21:false, honnete:0, faux:0, prie:false, reflex:false,
  cash:0, wealth:0, bmo:0, pull:0,
  dents:false, chambre:false, voiture:false, salleBain:false,
  xp:0, day:1, history:[], date: todayISO,
  quotes:[
    "Dream big, you can do anything.",
    "Small steps, huge results.",
    "Build the man before the empire.",
    "Discipline = Freedom.",
    "Aujourdâ€™hui, tu collectes des points. Demain, des contrats."
  ]
}, state.date===todayISO?state:{});

function save(){ localStorage.setItem('mp_state_v23', JSON.stringify(data)); document.getElementById('saveInfo').textContent='SauvÃ© '+new Date().toLocaleTimeString(); }
function el(id){return document.getElementById(id)}
function clamp(v,min,max){return Math.max(min, Math.min(max, v))}
function netWorth(){ return data.cash + data.wealth - data.bmo; }

// ---------- Sounds ----------
const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
function beep(freq=880, dur=0.08, type='sine', gain=0.06){
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type=type; o.frequency.value=freq;
  g.gain.value=gain;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  setTimeout(()=>{o.stop()}, dur*1000);
}
function okFx(){ beep(880,0.07,'square',0.06); setTimeout(()=>beep(1320,0.06,'square',0.05),60) }
function badFx(){ beep(200,0.09,'sawtooth',0.07) }
function clickFx(){ beep(520,0.04,'triangle',0.04) }

// ---------- Points system ----------
function pointsJour(){
  const sleepBonus = (data.sleep>=7 && data.sleep<=9)?12:0;
  const studyPts = Math.min(6, data.study)*3;
  const eauPts = data.eau*2;
  const pullPts = Math.min(20, data.pull)*1;
  const habits = (data.lever5?5:0) + (data.coucher21?5:0) + (data.prie?2:0) + (data.reflex?2:0);
  const integrity = data.honnete*1 - data.faux*2;
  const chores = (data.dents?2:0) + (data.chambre?3:0) + (data.voiture?3:0) + (data.salleBain?3:0);
  const penalties = data.nic*3 + data.weed*3 + data.alc*2 + data.porn*1;
  const raw = eauPts + sleepBonus + studyPts + pullPts + habits + integrity + chores - penalties;
  return Math.max(0, Math.round(raw));
}

function score(){
  const sante = Math.min(100, data.eau*8 + Math.max(0, Math.min(8,data.sleep))*5 ) 
               - (data.weed*6 + data.alc*5);
  const finance = Math.min(100, Math.max(0, Math.floor(netWorth()/100)));
  const mindset = data.study*6 + (data.lever5?3:0) + (data.coucher21?3:0) + (data.prie?2:0) + (data.reflex?2:0) + data.honnete - data.faux;
  const penal = data.nic*4 + data.weed*3 + data.alc*3 + data.porn*2;
  const power = Math.max(-100, Math.min(100, sante + mindset - penal));
  const bonheur = Math.max(0, Math.min(100, 40 + data.eau*2 + data.honnete - 2*data.faux - .5*(data.porn+data.nic) + (data.prie?2:0) + (data.reflex?2:0)));
  const points = pointsJour();
  return {sante:Math.round(sante),finance, mindset:Math.round(mindset), penal:Math.round(penal), power:Math.round(power), bonheur:Math.round(bonheur), points};
}

// ---------- UI builders ----------
function chip(title,val){ return `<div class="k"><div class="v">${val}</div><div class="t small">${title}</div></div>`}
function pill(lbl,val,good=true){return `<div class="pill ${good?'good':'bad'}"><span class="dot"></span>${lbl} <b>${val}</b></div>`}

function updKpis(){ 
  const s=score(); 
  el('kpis').innerHTML = 
    chip('ğŸ¯ Points du jour', s.points) +
    chip('XP cumulÃ©e', data.xp) +
    chip('Power',s.power)+
    chip('SantÃ©',s.sante)+
    chip('Finance',s.finance)+
    chip('Mindset',s.mindset)+
    chip('PÃ©nalitÃ©s',s.penal)+
    chip('Bonheur ğŸŒŸ',s.bonheur);
  const pct = Math.min(100, (data.xp/1000000)*100);
  el('progBar').style.width = pct.toFixed(2)+'%';
  el('progTxt').textContent = `${data.xp.toLocaleString()} / 1,000,000 points â€” ${pct.toFixed(2)}%`;
  el('dayBadge').textContent = 'ğŸ“… Day '+data.day;
}

function updPills(){ 
  const s=score();
  el('pills').innerHTML = 
    pill('ğŸ¯ Points', s.points, true)+
    pill('Eau',`${data.eau}/12`,true)+
    pill('Sommeil',`${data.sleep}h`,true)+
    pill('Ã‰tude',`${data.study}h`,true)+
    pill('ğŸª¥ Dents', data.dents?'âœ”':'â€”', true)+
    pill('ğŸ›ï¸ Chambre', data.chambre?'âœ”':'â€”', true)+
    pill('ğŸš— Voiture', data.voiture?'âœ”':'â€”', true)+
    pill('ğŸ› Salle de bain', data.salleBain?'âœ”':'â€”', true)+
    pill('Nicotine',data.nic,false)+
    pill('Weed',data.weed,false)+
    pill('Alcool',data.alc,false)+
    pill('Porn',data.porn,false)+
    pill('ğŸ’° Net worth', '$'+netWorth(),true)+
    pill('ğŸ™ PriÃ¨re',data.prie?'âœ”':'â€”',true)+
    pill('ğŸ§  RÃ©flexion',data.reflex?'âœ”':'â€”',true);
}

// bottles: dashboard and room
function drawDashBottles(){
  const c = el('dashBottles');
  c.innerHTML = '<div class="small" style="margin-right:6px">Objectif eau:</div>';
  for(let i=0;i<12;i++){
    const d=document.createElement('div'); d.className='bottle'+(i<data.eau?' fill':'');
    c.appendChild(d);
  }
}

function updCounters(){
  el('n_eau').textContent=data.eau;
  el('n_sleep').textContent=data.sleep;
  el('n_study').textContent=data.study;
  el('n_nic').textContent=data.nic;
  el('n_weed').textContent=data.weed;
  el('n_alc').textContent=data.alc;
  el('n_porn').textContent=data.porn;
  document.getElementById('lever5').checked=data.lever5;
  document.getElementById('coucher21').checked=data.coucher21;
  // room bottles
  const b=el('bottles'); b.innerHTML=''; for(let i=0;i<12;i++){const d=document.createElement('div');d.className='bottle'+(i<data.eau?' fill':'');b.appendChild(d)}
  // finance badges
  el('finBadges').innerHTML = ['Net worth: $'+netWorth(), 'Wealth: $'+data.wealth, 'Cash: $'+data.cash, 'Dettes: $'+data.bmo, 'XP: '+data.xp, 'Jour: '+data.day].map(t=>`<span class="badge">${t}</span>`).join('');
  drawDashBottles();
  updKpis(); updPills(); save();
}

// ---------- Quotes ----------
function newQuote(){
  const q = data.quotes[Math.floor(Math.random()*data.quotes.length)];
  el('quoteTxt').textContent = q;
}

// ---------- Actions & events ----------
function anim(type){
  const arm = el('armR'); const cup=el('cup'), can=el('can'), phone=el('phone'), smoke=el('smoke');
  cup.style.opacity=0; can.style.opacity=0; phone.style.opacity=0; smoke.style.opacity=0;
  if(type==='water'){cup.style.opacity=1; arm.style.transform='rotate(-35deg)'; setTimeout(()=>{arm.style.transform='rotate(0deg)';cup.style.opacity=0;},700)}
  if(type==='alc'){can.style.opacity=1; arm.style.transform='rotate(-35deg)'; setTimeout(()=>{arm.style.transform='rotate(0deg)';can.style.opacity=0;},800)}
  if(type==='porn'){phone.style.opacity=1; phone.classList.add('glow'); setTimeout(()=>phone.classList.remove('glow'),400); setTimeout(()=>{phone.style.opacity=0},900)}
  if(type==='smoke'){smoke.style.opacity=1; setTimeout(()=>{smoke.style.opacity=0},900)}
  if(type==='pull'){ const av=document.getElementById('avatar'); av.style.transition='transform .35s ease'; av.style.transform='translateY(-40px)'; setTimeout(()=>{av.style.transform='translateY(0)'},350); }
}

document.querySelectorAll('button[data-ctl]').forEach(b=>{
  b.addEventListener('click', e=>{
    const k = b.dataset.ctl, d=parseInt(b.dataset.d||'0',10);
    if(k==='eau'){ data.eau = clamp(data.eau + d,0,12); anim('water'); if(d>0) okFx(); else clickFx();}
    if(k==='sleep'){ data.sleep = clamp(data.sleep + d,0,24); clickFx(); }
    if(k==='study'){ data.study = clamp(data.study + d,0,24); okFx(); }
    if(k==='nic'){ data.nic = Math.max(0, data.nic + d); (d>0?badFx():clickFx()); anim('smoke'); }
    if(k==='weed'){ data.weed = Math.max(0, data.weed + d); (d>0?badFx():clickFx()); anim('smoke'); }
    if(k==='alc'){ data.alc = Math.max(0, data.alc + d); (d>0?badFx():clickFx()); anim('alc'); }
    if(k==='porn'){ data.porn = Math.max(0, data.porn + d); (d>0?badFx():clickFx()); anim('porn'); }
    updCounters();
  })
})

document.getElementById('lever5').addEventListener('change',e=>{data.lever5=e.target.checked; okFx(); updCounters()})
document.getElementById('coucher21').addEventListener('change',e=>{data.coucher21=e.target.checked; okFx(); updCounters()})
document.getElementById('btnPull').addEventListener('click',()=>{data.pull++; okFx(); anim('pull'); updCounters()})
document.getElementById('bHon').addEventListener('click',()=>{data.honnete++; okFx(); updCounters()})
document.getElementById('bFaux').addEventListener('click',()=>{data.faux++; badFx(); updCounters()})
document.getElementById('bPray').addEventListener('click',()=>{data.prie=!data.prie; okFx(); updCounters()})
document.getElementById('bReflect').addEventListener('click',()=>{data.reflex=!data.reflex; okFx(); updCounters()})
document.getElementById('bDents').addEventListener('click',()=>{data.dents=!data.dents; okFx(); updCounters()})
document.getElementById('bChambre').addEventListener('click',()=>{data.chambre=!data.chambre; okFx(); updCounters()})
document.getElementById('bVoiture').addEventListener('click',()=>{data.voiture=!data.voiture; okFx(); updCounters()})
document.getElementById('bSalleBain').addEventListener('click',()=>{data.salleBain=!data.salleBain; okFx(); updCounters()})
document.getElementById('btnQuote').addEventListener('click',()=>{ newQuote(); okFx(); })

// ----------- Reports (NB-LEL style) -----------
function snapshot(){
  const s=score();
  return {
    date: data.date, day:data.day, points:s.points, power:s.power, sante:s.sante, finance:s.finance, mindset:s.mindset, penal:s.penal, bonheur:s.bonheur,
    eau:data.eau, sleep:data.sleep, study:data.study, nic:data.nic, weed:data.weed, alc:data.alc, porn:data.porn,
    lever5:data.lever5, coucher21:data.coucher21, honnete:data.honnete, faux:data.faux, prie:data.prie, reflex:data.reflex,
    dents:data.dents, chambre:data.chambre, voiture:data.voiture, salleBain:data.salleBain,
    netWorth: netWorth()
  };
}

function rangeFilter(days){
  const now = new Date(data.date);
  const start = new Date(now); start.setDate(start.getDate()-(days-1));
  const sISO = start.toISOString().slice(0,10);
  return data.history.filter(h=>h.date>=sISO && h.date<=data.date);
}

function sum(arr, key){ return arr.reduce((a,x)=>a+(+x[key]||0),0) }
function avg(arr, key){ return arr.length? (sum(arr,key)/arr.length):0 }

function nblelText(arr, title){
  const pts=sum(arr,'points'); const pwr=Math.round(avg(arr,'power'));
  const sante=Math.round(avg(arr,'sante')); const fin=Math.round(avg(arr,'finance')); const ms=Math.round(avg(arr,'mindset'));
  const pen=Math.round(avg(arr,'penal')); const bon=Math.round(avg(arr,'bonheur'));
  const lines = [];
  lines.push(`NBâ€‘LEL â€” ${title}`);
  lines.push(`PÃ©riode: ${arr.length?arr[0].date+' â†’ '+arr[arr.length-1].date:data.date} | Jours analysÃ©s: ${arr.length||1}`);
  lines.push(``);
  lines.push(`Mon verdict: tu avances. Points rÃ©coltÃ©s: ${pts}. Power moyen: ${pwr}.`);
  lines.push(`SantÃ© ${sante}/100 â€” Mindset ${ms}/100 â€” Finance ${fin}/100 â€” PÃ©nalitÃ©s ${pen}/100 â€” Bonheur ${bon}/100.`);
  lines.push(``);
  lines.push(`Hydratation ${(avg(arr,'eau')).toFixed(1)}/12 | Sommeil ${(avg(arr,'sleep')).toFixed(1)} h | Ã‰tude ${(avg(arr,'study')).toFixed(1)} h.`);
  lines.push(`Nic ${avg(arr,'nic').toFixed(1)} | Weed ${avg(arr,'weed').toFixed(1)} | Alcool ${avg(arr,'alc').toFixed(1)} | Porn ${avg(arr,'porn').toFixed(1)}.`);
  lines.push(``);
  lines.push(`Conseil NBâ€‘LEL: garde la cadence, gagne tes points avant 21h, et protÃ¨ge ton sommeil. Rendezâ€‘vous demain pour faire mieux.`);
  return lines.join('\\n');
}

function buildReport(type='day'){
  let arr=[]; let title='';
  if(type==='day'){ arr=[snapshot()]; title='Rapport du jour'; }
  if(type==='week'){ arr=rangeFilter(7); title='Rapport de la semaine'; if(arr.length===0) arr=[snapshot()]; }
  if(type==='month'){ arr=rangeFilter(30); title='Rapport du mois'; if(arr.length===0) arr=[snapshot()]; }
  if(type==='year'){ arr=rangeFilter(365); title="Rapport de l'annÃ©e"; if(arr.length===0) arr=[snapshot()]; }
  return nblelText(arr,title);
}

let currentReportType='day';
document.getElementById('btnReport').addEventListener('click',()=>{
  currentReportType='day';
  el('report').textContent = buildReport('day');
  el('modal').style.display='grid';
})
document.querySelectorAll('[data-rpt]').forEach(b=>{
  b.addEventListener('click',()=>{
    const t=b.getAttribute('data-rpt'); currentReportType=t;
    el('report').textContent = buildReport(t);
  })
})
el('btnPDF').addEventListener('click',()=>{
  // open printable window with NB-LEL styled content
  const w=window.open('','_blank');
  const text = el('report').textContent;
  const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Rapport NBâ€‘LEL</title>
  <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:30px; color:#111}
  h1{font-size:20px;margin:0 0 10px} pre{white-space:pre-wrap;font-size:14px;line-height:1.4}
  .muted{color:#666;font-size:12px;margin-top:10px}</style></head><body>
  <h1>Millionaire Power â€” ${currentReportType.toUpperCase()}</h1>
  <pre>${text.replace(/</g,'&lt;')}</pre>
  <div class="muted">GÃ©nÃ©rÃ© par NBâ€‘LEL â€” ${new Date().toLocaleString()}</div>
  <script>window.print()</script>
  </body></html>`;
  w.document.write(html); w.document.close();
})

document.getElementById('closeM').onclick=()=>el('modal').style.display='none';

// ----------- Finish day -----------
document.getElementById('btnFinish').addEventListener('click',()=>{
  const s=score();
  const snap = snapshot();
  data.history.push(snap);
  data.xp += s.points;
  data.day += 1;
  Object.assign(data,{eau:0,sleep:0,study:0,nic:0,weed:0,alc:0,porn:0,lever5:false,coucher21:false,honnete:0,faux:0,prie:false,reflex:false,pull:0,dents:false,chambre:false,voiture:false,salleBain:false});
  data.date = new Date(new Date(data.date).getTime()+86400000).toISOString().slice(0,10);
  okFx(); okFx(); updCounters();
})

// ----------- Mode Test (configurable) -----------
document.getElementById('btnTest').addEventListener('click',()=>{
  el('modalTest').style.display='grid';
})
document.getElementById('closeT').onclick=()=>el('modalTest').style.display='none';

document.getElementById('launchTest').addEventListener('click',()=>{
  const days = parseInt(document.getElementById('testDuration').value,10);
  const diff = document.getElementById('testDiff').value;
  const cfg = {
    easy:{pGood:.7, penMul:.7, speed:120},
    normal:{pGood:.55, penMul:1.0, speed:100},
    hard:{pGood:.42, penMul:1.3, speed:80},
    insane:{pGood:.32, penMul:1.6, speed:60}
  }[diff];
  el('modalTest').style.display='none';
  let d=0;
  const id=setInterval(()=>{
    // simulate a day
    const r=()=>Math.random();
    data.eau = Math.min(12, Math.round(12*r()));
    data.sleep = Math.round(9*r());
    data.study = Math.round(3*r()/ (cfg.pGood>0? (1/cfg.pGood):1 ) );
    data.nic = Math.max(0, Math.round((r()<cfg.pGood?0:2*r())*cfg.penMul));
    data.weed = Math.max(0, Math.round((r()<cfg.pGood?0:2*r())*cfg.penMul));
    data.alc = Math.max(0, Math.round((r()<cfg.pGood?0:3*r())*cfg.penMul));
    data.porn = Math.max(0, Math.round((r()<cfg.pGood?0:3*r())*cfg.penMul));
    data.lever5 = r()<cfg.pGood;
    data.coucher21 = r()<cfg.pGood;
    data.prie = r()<cfg.pGood;
    data.reflex = r()<cfg.pGood;
    data.honnete = Math.round(3*r());
    data.faux = Math.round((r()<cfg.pGood?.2:1.2)*r());
    data.dents = r()<Math.max(.8*cfg.pGood,.3);
    data.chambre = r()<.5*cfg.pGood;
    data.voiture = r()<.3*cfg.pGood;
    data.salleBain = r()<.35*cfg.pGood;
    updCounters();
    // finish day
    const s=score(); data.history.push(snapshot()); data.xp += s.points; data.day += 1;
    Object.assign(data,{eau:0,sleep:0,study:0,nic:0,weed:0,alc:0,porn:0,lever5:false,coucher21:false,honnete:0,faux:0,prie:false,reflex:false,pull:0,dents:false,chambre:false,voiture:false,salleBain:false});
    data.date = new Date(new Date(data.date).getTime()+86400000).toISOString().slice(0,10);
    if(++d>=days){ clearInterval(id); okFx(); okFx(); }
  }, cfg.speed);
})

// ----------- Init -----------
function init(){ newQuote(); updCounters(); }
init();

// disable double-tap zoom on iPad
let lastTouch=0; document.addEventListener('touchend',e=>{const now=Date.now(); if(now-lastTouch<=300){ e.preventDefault() } lastTouch=now }, {passive:false});
</script>
</body>
</html>
